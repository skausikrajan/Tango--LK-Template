<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixture Management System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
            margin: 0;
            background-color: #f2f2f2;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 600px;
            background: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            min-height: 80vh;
        }

        #search-bar-section {
            position: relative;
            margin-bottom: 20px;
        }

        #searchInput {
            width: 100%;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
            font-size: 16px;
            box-sizing: border-box;
        }

        #searchSuggestions {
            position: absolute;
            width: 100%;
            top: 100%;
            left: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .suggestion-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background-color: #f0f0f0;
        }

        #main-content {
            flex-grow: 1;
        }
        
        #goBackBtn {
            margin-top: 20px;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            background-color: #6c757d;
            color: white;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #goBackBtn:hover {
            background-color: #5a6268;
        }

        #addDataForm, #editDataForm {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        #addDataForm input, #editDataForm input, .data-management-container input, .data-management-container button {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        #dataList {
            margin-top: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }

        .fixture-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .fixture-item:last-child {
            border-bottom: none;
        }

        #bottom-panel {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        #libraryOptions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }
        
        .deleteBtn {
             background-color: #dc3545;
        }
        .deleteBtn:hover {
             background-color: #c82333;
        }
        .editBtn {
             background-color: #ffc107;
             color: #212529;
        }
        .editBtn:hover {
             background-color: #e0a800;
        }

        .filter-container {
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        .filter-container select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-right: 10px;
        }

        #resultTemplate {
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        
        .data-management-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="search-bar-section">
            <input type="text" id="searchInput" placeholder="Search for a fixture..." autocomplete="off">
            <div id="searchSuggestions"></div>
        </div>

        <div id="main-content">
            <div id="display-area"></div>
        </div>

        <div id="bottom-panel">
            <button id="libraryButton">Library</button>
            <div id="libraryOptions" style="display: none;">
                <button id="addDataButton">Add Data</button>
                <button id="removeDataButton">Remove Data</button>
                <button id="editDataButton">Edit Data</button>
                <button id="importCsvButton">Import CSV Data</button>
            </div>
        </div>
    </div>

    <script>
        // Load data from localStorage or initialize empty array
        let fixtures = JSON.parse(localStorage.getItem('fixtures')) || [];
        const password = "Tango Eye";

        document.getElementById('libraryButton').addEventListener('click', () => {
            const libraryOptions = document.getElementById('libraryOptions');
            libraryOptions.style.display = libraryOptions.style.display === 'none' ? 'flex' : 'none';
        });

        function saveFixtures() {
            // Re-sort the array by name to improve search/display consistency
            fixtures.sort((a, b) => a.name.localeCompare(b.name));
            localStorage.setItem('fixtures', JSON.stringify(fixtures));
        }
        
        function returnToMain() {
            document.getElementById('main-content').innerHTML = '<div id="display-area"></div>';
            document.getElementById('libraryOptions').style.display = 'none';
        }

        // =========================================================================
        // === Data Validation Functions (Matches your requested conditions) ===
        // =========================================================================
        
        // Fixture Name and Template Name: Allows text and integers (no special characters)
        function isValidTextAndNumbers(str) { return /^[a-zA-Z0-9\s]+$/.test(str.trim()); }
        
        // Fixture Type: Supports only text
        function isValidFixtureType(str) { return /^[a-zA-Z\s]+$/.test(str.trim()); }
        
        // Fixture Ft: Supports only integer
        function isValidFixtureFt(val) { 
            const num = parseInt(val, 10);
            return !isNaN(num) && isFinite(val) && String(num) === String(val).trim() && num > 0;
        } 
        
        function validateFixture(name, type, ft, template) {
            if (!isValidTextAndNumbers(name)) {
                return 'Fixture Name must contain only text and numbers (no special characters).';
            }
            if (!isValidFixtureType(type)) {
                return 'Fixture Type must contain only text.';
            }
            if (!isValidFixtureFt(ft)) {
                return 'Fixture Ft must be a positive integer.';
            }
            if (!isValidTextAndNumbers(template)) {
                return 'Template Name must contain only text and numbers (no special characters).';
            }
            return null; // Null means valid
        }
        // =========================================================================


        // === Add Data Function (Uses the validation logic) ===
        document.getElementById('addDataButton').addEventListener('click', () => {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div id="display-area"></div>
                <form id="addDataForm">
                    <h3>Add New Fixture</h3>
                    <input type="text" id="fixtureName" placeholder="Fixture Name (Text & Integers)" required>
                    <input type="text" id="fixtureType" placeholder="Fixture Type (Text)" required>
                    <input type="number" id="fixtureFt" placeholder="Fixture Ft (Integer)" required>
                    <input type="text" id="templateName" placeholder="Template Name (Text & Integers)" required>
                    <button type="submit" id="saveDataButton">Save Data</button>
                </form>
                <button id="goBackBtn">Return to Main Menu</button>
            `;

            document.getElementById('addDataForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('fixtureName').value.trim();
                const type = document.getElementById('fixtureType').value.trim();
                const ft = document.getElementById('fixtureFt').value; // Keep as string for strict validation check
                const template = document.getElementById('templateName').value.trim();
                
                const validationError = validateFixture(name, type, ft, template);

                if (validationError) {
                    alert('Input Error: ' + validationError);
                    return;
                }

                const newFixture = { id: Date.now(), name, type, ft: parseInt(ft, 10), template };
                fixtures.push(newFixture);
                saveFixtures();
                alert('Data saved successfully! 👍');
                returnToMain();
            });
            document.getElementById('goBackBtn').addEventListener('click', returnToMain);
        });

        // === CSV Import Functionality (Uses the validation logic) ===
        document.getElementById('importCsvButton').addEventListener('click', () => {
             const passwordInput = prompt("Please enter the password for Import:");
            if (passwordInput !== password) {
                alert("Incorrect password.");
                return;
            }
            
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div id="display-area"></div>
                <div class="data-management-container">
                    <h3>Import CSV Fixture Data</h3>
                    <p>Expected format: Fixture Name, Fixture Type, Fixture Ft, Template Name.</p>
                    <input type="file" id="csvFileInput" accept=".csv" required>
                    <button id="processCsvButton">Process CSV</button>
                </div>
                <button id="goBackBtn">Return to Main Menu</button>
            `;
            
            document.getElementById('goBackBtn').addEventListener('click', returnToMain);
            document.getElementById('processCsvButton').addEventListener('click', processCsvFile);
        });

        function processCsvFile() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const csvText = e.target.result;
                const importedData = parseCSV(csvText);
                
                if (importedData.length === 0) {
                    alert('No valid data found in the CSV file.');
                    return;
                }
                
                if (confirm(`Found ${importedData.length} valid records. Do you want to REPLACE ALL existing data with this imported data? (Cancel to APPEND to existing data)`)) {
                    fixtures = importedData;
                    alert(`Successfully replaced all data with ${importedData.length} new records! 💾`);
                } else {
                    fixtures = fixtures.concat(importedData);
                    alert(`Successfully appended ${importedData.length} records to existing data! 📝`);
                }
                
                saveFixtures();
                returnToMain();
            };
            
            reader.onerror = () => {
                alert('Error reading the file.');
            };

            reader.readAsText(file);
        }
        
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n').filter(line => line.trim() !== '');
            const newFixtures = [];
            let invalidRowCount = 0;

            for (let i = 0; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                
                // Expect 4 columns: Name, Type, Ft, Template
                if (values.length >= 4) {
                    const name = values[0];
                    const type = values[1];
                    const ft = values[2]; // Passed as string for strict validation
                    const template = values[3];
                    
                    const validationError = validateFixture(name, type, ft, template);
                    
                    if (validationError) {
                        console.warn(`Skipping invalid row ${i + 1}: ${validationError} - Data: ${lines[i]}`);
                        invalidRowCount++;
                        continue; // Skip invalid rows
                    }
                    
                    // Add the valid fixture, converting Ft back to an integer
                    newFixtures.push({ 
                        id: Date.now() + i, 
                        name, 
                        type, 
                        ft: parseInt(ft, 10), 
                        template 
                    });
                }
            }
            if (invalidRowCount > 0) {
                alert(`Warning: ${invalidRowCount} rows were skipped due to invalid data format.`);
            }
            return newFixtures;
        }


        // === Remove, Edit, and Search Functions (Same as previous, using consistent validation) ===
        function showDataManagement(action) {
            const passwordInput = prompt("Please enter the password:");
            if (passwordInput !== password) {
                alert("Incorrect password.");
                return;
            }

            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div id="display-area"></div>
                <div class="data-management-container">
                    <h3>${action === 'remove' ? 'Remove' : 'Edit'} Fixtures</h3>
                    <input type="text" id="dataSearchInput" placeholder="Search data by Fixture Name...">
                    <div id="dataList"></div>
                </div>
                <button id="goBackBtn">Return to Main Menu</button>
            `;

            const dataSearchInput = document.getElementById('dataSearchInput');
            dataSearchInput.addEventListener('input', () => {
                displayFixtures(dataSearchInput.value, action);
            });

            displayFixtures('', action);
            document.getElementById('goBackBtn').addEventListener('click', returnToMain);
        }

        function displayFixtures(searchTerm, action) {
            const dataList = document.getElementById('dataList');
            dataList.innerHTML = '';
            const filteredFixtures = fixtures.filter(f => f.name.toLowerCase().includes(searchTerm.toLowerCase()));

            if (filteredFixtures.length === 0) {
                dataList.innerHTML = '<p>No matching fixtures found.</p>';
                return;
            }

            filteredFixtures.forEach(fixture => {
                const fixtureElement = document.createElement('div');
                fixtureElement.classList.add('fixture-item');
                fixtureElement.innerHTML = `
                    <div>
                        <strong>${fixture.name}</strong> - Type: ${fixture.type}, Ft: ${fixture.ft}, Template: ${fixture.template}
                    </div>
                    <div>
                        ${action === 'edit' ? `<button class="editBtn" data-id="${fixture.id}">Edit</button>` : ''}
                        <button class="deleteBtn" data-id="${fixture.id}">Delete</button>
                    </div>
                `;
                dataList.appendChild(fixtureElement);
            });

            dataList.querySelectorAll('.deleteBtn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    deleteData(e.target.dataset.id, action);
                });
            });

            if (action === 'edit') {
                dataList.querySelectorAll('.editBtn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        editData(e.target.dataset.id);
                    });
                });
            }
        }

        function deleteData(id, action) {
            if (confirm('Are you sure you want to delete this data?')) {
                fixtures = fixtures.filter(f => f.id != id);
                saveFixtures();
                alert('Data deleted successfully! 🗑️');
                showDataManagement(action);
            }
        }

        function editData(id) {
            const fixtureToEdit = fixtures.find(f => f.id == id);
            if (!fixtureToEdit) return;

            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div id="display-area"></div>
                <form id="editDataForm">
                    <h3>Edit Fixture: ${fixtureToEdit.name}</h3>
                    <input type="text" id="editFixtureName" value="${fixtureToEdit.name}">
                    <input type="text" id="editFixtureType" value="${fixtureToEdit.type}">
                    <input type="number" id="editFixtureFt" value="${fixtureToEdit.ft}">
                    <input type="text" id="editTemplateName" value="${fixtureToEdit.template}">
                    <button type="submit" id="updateButton">Update</button>
                </form>
                <button id="goBackBtn">Return to Main Menu</button>
            `;

            document.getElementById('editDataForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const newName = document.getElementById('editFixtureName').value.trim();
                const newType = document.getElementById('editFixtureType').value.trim();
                const newFt = document.getElementById('editFixtureFt').value;
                const newTemplate = document.getElementById('editTemplateName').value.trim();

                const validationError = validateFixture(newName, newType, newFt, newTemplate);

                if (validationError) {
                    alert('Input Error: ' + validationError);
                    return;
                }

                fixtureToEdit.name = newName;
                fixtureToEdit.type = newType;
                fixtureToEdit.ft = parseInt(newFt, 10);
                fixtureToEdit.template = newTemplate;

                saveFixtures();
                alert('Data updated successfully! ✍️');
                showDataManagement('edit');
            });
            document.getElementById('goBackBtn').addEventListener('click', returnToMain);
        }

        document.getElementById('removeDataButton').addEventListener('click', () => showDataManagement('remove'));
        document.getElementById('editDataButton').addEventListener('click', () => showDataManagement('edit'));

        // === Search Bar Functionality (Main View) ===
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const searchSuggestions = document.getElementById('searchSuggestions');
            searchSuggestions.innerHTML = '';

            if (!searchTerm) {
                searchSuggestions.style.display = 'none';
                document.getElementById('display-area').innerHTML = '';
                return;
            }

            const matchedFixtures = fixtures.filter(f => f.name.toLowerCase().includes(searchTerm));
            const uniqueNames = [...new Set(matchedFixtures.map(f => f.name))];

            uniqueNames.forEach(name => {
                const suggestionDiv = document.createElement('div');
                suggestionDiv.textContent = name;
                suggestionDiv.classList.add('suggestion-item');
                suggestionDiv.addEventListener('click', () => {
                    document.getElementById('searchInput').value = name;
                    searchSuggestions.style.display = 'none';
                    showFilterOptions(name);
                });
                searchSuggestions.appendChild(suggestionDiv);
            });

            searchSuggestions.style.display = uniqueNames.length > 0 ? 'block' : 'none';
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#search-bar-section')) {
                document.getElementById('searchSuggestions').style.display = 'none';
            }
        });

        function showFilterOptions(fixtureName) {
            const displayArea = document.getElementById('display-area');
            const filteredFixtures = fixtures.filter(f => f.name === fixtureName);
            
            const uniqueTypes = [...new Set(filteredFixtures.map(f => f.type))];
            const uniqueFts = [...new Set(filteredFixtures.map(f => f.ft))].sort((a, b) => a - b);

            displayArea.innerHTML = `
                <div class="filter-container">
                    <h3>Template Lookup for: ${fixtureName}</h3>
                    <label for="typeSelect">Fixture Type:</label>
                    <select id="typeSelect">
                        <option value="">--Select Type--</option>
                        ${uniqueTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                    </select>
                    <label for="ftSelect">Fixture Ft:</label>
                    <select id="ftSelect">
                        <option value="">--Select Ft--</option>
                        ${uniqueFts.map(ft => `<option value="${ft}">${ft}</option>`).join('')}
                    </select>
                    <div id="resultTemplate"></div>
                </div>
            `;

            const typeSelect = document.getElementById('typeSelect');
            const ftSelect = document.getElementById('ftSelect');
            const resultTemplate = document.getElementById('resultTemplate');

            const updateTemplateDisplay = () => {
                const selectedType = typeSelect.value;
                const selectedFt = parseInt(ftSelect.value, 10); 
                let templateFound = false;

                if (selectedType && selectedFt) {
                    const finalMatch = fixtures.find(f => f.name === fixtureName && f.type === selectedType && f.ft === selectedFt);
                    if (finalMatch) {
                        resultTemplate.innerHTML = `<h4>Template Name: ${finalMatch.template}</h4>`;
                        templateFound = true;
                    }
                }
                
                if (!templateFound) {
                    resultTemplate.innerHTML = '<p>No template found for the selected combination.</p>';
                }
            };

            typeSelect.addEventListener('change', updateTemplateDisplay);
            ftSelect.addEventListener('change', updateTemplateDisplay);
        }
        
        returnToMain(); 
    </script>
</body>
</html>
